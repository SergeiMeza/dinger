language: ruby
cache: bundler
sudo: required
git:
  depth: 9999
branches:
  except:
    - "/^[0-9]/"
services:
  - docker
before_install:
  - |
    if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_BRANCH" = "master" ]; then
      echo "Do not open PRs against master; merge dev into master locally and push instead."
      exit 1
    fi
  - export DOCKER_IMAGE_TAG=665b9213b0e5d5281457fcc2007a5061a2d22976
  - openssl aes-256-cbc -K $encrypted_13d4b12ffe60_key -iv $encrypted_13d4b12ffe60_iv -in firebase-crashreporting-private-key.json.enc -out firebase-crashreporting-private-key.json -d
  - docker pull stoyicker/docker-android:${DOCKER_IMAGE_TAG}
  - docker tag stoyicker/docker-android:${DOCKER_IMAGE_TAG} stoyicker/docker-android
  - |
    export CONTAINER=$(docker run -dt -p 127.0.0.1:80:4567 stoyicker/docker-android -e TRAVIS_BRANCH -e REPO_USER -e GITHUB_TOKEN -e TRAVIS_REPO_SLUG)
  - docker exec -t $CONTAINER /bin/sh -c "mkdir -p /root/${TRAVIS_REPO_SLUG}"
  - docker cp ./ $CONTAINER:root/${TRAVIS_REPO_SLUG}
env:
  matrix:
  - TASK="./gradlew :app:clean :app:build :app:check :app:dokka --no-daemon"
  - TASK="./gradlew :domain:clean :domain:build :domain:check :domain:dokka --no-daemon"
  - TASK="./gradlew :data:clean :data:build :data:check :data:dokka --no-daemon"
  - TASK="./gradlew :crash-reporter:build :crash-reporter:check :crash-reporter:dokka --no-daemon"
  - TASK="./gradlew :event-tracker:build :event-tracker:check :event-tracker:dokka --no-daemon"
script:
  - docker exec -t $CONTAINER /bin/sh -c "cd root/${TRAVIS_REPO_SLUG}; ./ci/script.sh ${TASK}"
after_success:
  - |
    if [ "$TRAVIS_PULL_REQUEST" = "false" ] && [ "$TRAVIS_BRANCH" = "master" ] && [[ "$TRAVIS_JOB_NUMBER" == *.1 ]]; then
      echo "CI on master succeded. Executing release tasks..."
      docker exec -t $CONTAINER /bin/sh -c "cd root/${TRAVIS_REPO_SLUG}; ./ci/release.sh"
      echo "Uploading mapping to Firebase..."
      docker exec -t $CONTAINER /bin/sh -c "cd root/${TRAVIS_REPO_SLUG}; ./gradlew :app:firebaseUploadReleaseProguardMapping"
    fi
notifications:
  email:
    recipients:
      - jorge.diazbenitosoriano@gmail.com
    on_success: change
    on_failure: always
